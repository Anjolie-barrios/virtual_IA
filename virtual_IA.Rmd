---
title: "virtual_IA"
author: "Anjolie"
date: "2/9/2022"
output: 
  html_document:
    number_sections: true
    toc: true
---

```{r setup, include=FALSE}
##add table of contents
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(knitr)
require(mosaic)
require(lattice)
require(ggplot2)
require(tigerstats)
require(forcats)
require(dplyr)
library(magrittr)

#raw
virtual_raw <- read_csv("virtual_raw.csv", 
    col_types = cols(
      ValueType = col_skip(), 
        `Location type` = col_skip(), `Period type` = col_skip(), 
        `Dim1 type` = col_skip(), `Dim2 type` = col_skip(), 
        `Dim3 type` = col_skip(), Dim3 = col_skip(), 
        Dim3ValueCode = col_skip(), DataSourceDimValueCode = col_skip(), 
        DataSource = col_skip(), FactValueNumericPrefix = col_skip(), 
        FactValueUoM = col_skip(), FactValueNumericLowPrefix = col_skip(), 
        FactValueNumericHighPrefix = col_skip(), 
        FactValueTranslationID = col_skip(), 
        FactComments = col_skip(), 
      IsLatestYear = col_skip(), Indicator = col_skip(), IndicatorCode = col_skip(), ParentLocationCode = col_skip(), ParentLocation = col_skip(), Dim2ValueCode = col_skip(), Language = col_skip(), DateModified = col_skip()
        )
    )
##location as factor
virtual_raw$location <- as.factor(virtual_raw$Location)
virtual_raw <- select(virtual_raw, -Location)

##disease as factor
virtual_raw$disease <- as.factor(virtual_raw$Dim2)
virtual_raw <- select(virtual_raw, -Dim2)

##sex as a factor
virtual_raw$sexCat <- as.factor(virtual_raw$Dim1)
virtual_raw <- select(virtual_raw, -Dim1)

##new factor for 'margin of error' (is it a margin? check WHO website for how highs and lows were calculated)


# MAKING SUBSETS
##by country
raw_JP <- subset(virtual_raw, location == "Japan")
  raw_JP <- select(raw_JP, -location)
raw_US <- subset(virtual_raw, virtual_raw$location =="United States of America")
  raw_US <- select(raw_US, -location)
raw_UK <- subset(virtual_raw, virtual_raw$location == "United Kingdom of Great Britain and Northern Ireland")
  raw_UK <- select(raw_UK, -location)

#raw, only diabetes and resp diseases
rawUS_diabetes <- subset(raw_US, raw_US$disease =="Diabetes mellitus")
rawUS_resp <- subset(raw_US, raw_US$disease =="Respiratory diseases")
## for Japan
rawJP_diabetes <- subset(raw_JP, raw_JP$disease =="Diabetes mellitus")
rawJP_resp <- subset(raw_JP, raw_JP$disease =="Respiratory diseases")
## UK
rawUK_diabetes <- subset(raw_UK, raw_UK$disease =="Diabetes mellitus")
rawUK_resp <- subset(raw_UK, raw_UK$disease =="Respiratory diseases")

#US by sex categories
rawUS_allSex <- subset(raw_US, raw_US$sexCat == "Both sexes")

rawUSdiabetes_allSex <- subset(rawUS_diabetes, rawUS_diabetes$sexCat =="Both sexes")
  rawUSdiabetes_2sex <- rawUS_diabetes[!(rawUS_diabetes$sexCat=="Both sexes"),]

  #female vs male
    rawUSdiabetes_F <- subset(rawUS_diabetes, rawUS_diabetes$sexCat =="Female")
    rawUSdiabetes_M <- subset(rawUS_diabetes, rawUS_diabetes$sexCat =="Male")

rawUSresp_allSex <- subset(rawUS_resp, rawUS_resp$sexCat =="Both sexes")
  rawUSresp_2sex <- rawUS_resp[!(rawUS_resp$sexCat=="Both sexes"),]
   
   #female vs male
  rawUSresp_F <- subset(rawUS_resp, rawUS_resp$sexCat =="Female")
  rawUSresp_M <- subset(rawUS_resp, rawUS_resp$sexCat =="Male")

  
##JP by sex cats
rawJP_allSex <- subset(raw_JP, raw_JP$sexCat == "Both sexes")

rawJPdiabetes_allSex <- subset(rawJP_diabetes, rawJP_diabetes$sexCat =="Both sexes")
  rawJPdiabetes_2sex <- rawJP_diabetes[!(rawJP_diabetes$sexCat=="Both sexes"),]

rawJPresp_allSex <- subset(rawJP_resp, rawJP_resp$sexCat =="Both sexes")
  rawJPresp_2sex <- rawJP_resp[!(rawJP_resp$sexCat=="Both sexes"),]
  
   #female vs male, diab
    rawJPdiabetes_F <- subset(rawJP_diabetes, rawJP_diabetes$sexCat =="Female")
    rawJPdiabetes_M <- subset(rawJP_diabetes, rawJP_diabetes$sexCat =="Male")
   
   #female vs male, resp
  rawJPresp_F <- subset(rawJP_resp, rawJP_resp$sexCat =="Female")
  rawJPresp_M <- subset(rawJP_resp, rawJP_resp$sexCat =="Male")
  
##UK by sex cats

rawUK_allSex <- subset(raw_UK, raw_UK$sexCat == "Both sexes")

rawUKdiabetes_allSex <- subset(rawUK_diabetes, rawUK_diabetes$sexCat =="Both sexes")
  rawUKdiabetes_2sex <- rawUK_diabetes[!(rawUK_diabetes$sexCat=="Both sexes"),]

rawUKresp_allSex <- subset(rawUK_resp, rawUK_resp$sexCat =="Both sexes")
  rawUKresp_2sex <- rawUK_resp[!(rawUK_resp$sexCat=="Both sexes"),]
  
  #female vs male, diab
    rawUKdiabetes_F <- subset(rawUK_diabetes, rawUK_diabetes$sexCat =="Female")
    rawUKdiabetes_M <- subset(rawUK_diabetes, rawUK_diabetes$sexCat =="Male")
   
   #female vs male, resp
  rawUKresp_F <- subset(rawUK_resp, rawUK_resp$sexCat =="Female")
  rawUKresp_M <- subset(rawUK_resp, rawUK_resp$sexCat =="Male")
  

  
if(!require("rglwidget")) {install.packages("rglwidget");require("rglwidget")}
```

# title, exploration, etc

$H_A$: In these countries, there's a significant difference in the number of deaths from diabetes between the sexes. 

$H_0$: In these countries, the number of deaths from diabetes is independent from sex. 

## US, comparing diseases

```{r}
## is this necessary?
basicCN <- ggplot(rawUS_allSex,aes(x=disease,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="Comparing diseases in the US", x = "disease", y = "deaths")
```

In the US, regardless of sex, cardiovascular diseases are the deadliest of the 4 categories, followed by neoplasms and respiratory diseases. Diabetes, comparatively, kills very few people; this can be explained by diabetes being only 2 diseases (type 1 and type 2), as opposed to broader categories like respiratory and cardiovascular diseases. Even so, diabetes seems  (proportionally to other diseases) like a bigger killer than in the UK or Japan. 


### US diabetes (regardless of sex) - numeric 

```{r, include=FALSE}
#graph setup
USdiabetes_allSex <- select(rawUSdiabetes_allSex, -Dim1ValueCode)
USdiabetes_allSex <- select(USdiabetes_allSex, -Value)
USdiabetes_allSex <- select(USdiabetes_allSex, -sexCat)
USdiabetes_allSex <- select(USdiabetes_allSex, -disease)
USdiabetes_allSex <- select(USdiabetes_allSex, -SpatialDimValueCode)

##remove period later so the graph still works
USdiabetes_allSexSummary <- select(USdiabetes_allSex, -Period)
```

```{r}
summary(USdiabetes_allSex)
```
#### US diabetes (regardless of sex) - graphical

```{r summary}
require(scales)
#graphical model w/ regression. For US diabetes regardless of sex. 
model.USdiabetesAllsex <- lm(FactValueNumeric ~ Period, data = USdiabetes_allSex)
pred1 <- predict(model.USdiabetesAllsex, interval="prediction")
#model for factvalue Highs and Lows
model.USdiabHigh <- lm(FactValueNumericHigh ~ Period, data = USdiabetes_allSex)
model.USdiabLow <- lm(FactValueNumericLow ~ Period, data = USdiabetes_allSex)

#actual graph
new_USdiabetesAllsex <- cbind(USdiabetes_allSex, pred1)
ggplot(new_USdiabetesAllsex, aes(Period, FactValueNumeric))+
    geom_point() + expand_limits(y= 55000) +
    geom_line(aes (Period, FactValueNumericHigh), color = "red", linetype = "dashed") +
    geom_line(aes (Period, FactValueNumericLow), color = "red", linetype = "dashed") +
    geom_smooth(method=lm, se=TRUE) + labs(title = "US diabetes (all sexes) over time", x= "year", y = "deaths") + scale_y_continuous(labels = comma)

summary.lm(model.USdiabetesAllsex)
```

  Because of human error during data collecting, the number of deaths per year cannot be entirely certain; "Fact Value Numeric Low" is the lowest number of deaths probable in a certain year, and "Fact Value Numeric High" is the highest probable number of deaths. 
  For example, in 2019 diabetes killed around 87,774, and the median of "Fact Value Numeric" is 74,823. However, the 'true' values in 2019 would be "87,774 [71,323 â€“ 10,4760]", meaning it could be as low as 71K ("Numeric Low") or as high as 10K ("Numeric High"). Numeric "highs" and "lows" that are farther apart from the estimated value mean less certainty. 
  
  The average number of deaths from diabetes (per year) was 75,993. If the null hypothesis is true, about 35,000 deaths per sex would be expected per year (sex demographics are about even for the US and JP). 
  
  The regression line (blue on the graph) is [deaths] = 677.1 * [year] - 1284550.5. 

## US boxplot, between sexes

```{r}
#diabetes
##setting percents manually? doesn't need an extra graph. just find ratio
resF <- c(sum(rawUSdiabetes_F$FactValueNumeric))
resM <- c(sum(rawUSdiabetes_M$FactValueNumeric))
resAll <- c(sum(rawUSdiabetes_allSex$FactValueNumeric))

F_perc <- 

basicCN <- ggplot(rawUSdiabetes_2sex,aes(x=sexCat,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="Diabetes in the US by sex (total deaths)", x = "sex", y= "deaths")
```

### diabetes (graphical and numeric)

```{r}
#female vs male, diabetes

  #diabetes
plot(rawUSdiabetes_M$Period, rawUSdiabetes_M$FactValueNumeric, type = "l",  col="blue",                               
     main = "US diabetes by sex, over time",
     xlab = "year",
     ylab = "deaths")
lines(rawUSdiabetes_F$Period, rawUSdiabetes_F$FactValueNumeric, type = "l", col = "red") 
    #ablines for male, fem
abline(reg = lm(rawUSdiabetes_M$FactValueNumeric ~ rawUSdiabetes_M$Period), col = "blue", lty = 2)
  abline(reg = lm(rawUSdiabetes_F$FactValueNumeric ~ rawUSdiabetes_F$Period), col = "red", lty = 2)
    #legend
legend("topleft",                                       # Add legend to plot
       legend = c("Female", "Male"),
       col = c("red", "blue"),
       lty = 1)
legend("top", 
       legend = c("F (best fit)", "M (best fit)"), 
       col = c("red", "blue"), 
       lty = 2)

#numerical  #setup (making models for regression). mention y= mx+b equations in analysis. 
  model.USdiabetes_F <- lm(FactValueNumeric ~ Period, data = rawUSdiabetes_F)
  model.USdiabetes_M <- lm(FactValueNumeric ~ Period, data = rawUSdiabetes_M)
```
  
  Diabetes killing more females before 2010 might be explained by men dying earlier from other dangers like workplace hazards; modern society, due to expanded safety regulation in the workplace and otherwise, is much safer. But the upward spike afterwards (in male diabetes deaths) is still suspect and probably has other explanations, like the 2008 recession which introduced other immediate dangers like starvation due to a spike of mass unemployment. Even with the slow drop-off in unemployment after 2010, the recession seems to be have long-lasting effects. Overall, males are killed far more often by diabetes than females. 
  
```{r summaries, include=FALSE}
#numerical  
#setup (making models for regression). mention y= mx+b equations in analysis. 
  model.USdiabetes_F <- lm(FactValueNumeric ~ Period, data = rawUSdiabetes_F)
  model.USdiabetes_M <- lm(FactValueNumeric ~ Period, data = rawUSdiabetes_M)
  
  #cleaning up (fem summary)
USdiabetes_F <- select(rawUSdiabetes_F, -SpatialDimValueCode)
USdiabetes_F <- select(USdiabetes_F, -Dim1ValueCode)
USdiabetes_F <- select(USdiabetes_F, -Value)
USdiabetes_F <- select(USdiabetes_F, -sexCat)
USdiabetes_F <- select(USdiabetes_F, -disease)

#cleaning up (male summary)
USdiabetes_M <- select(rawUSdiabetes_M, -SpatialDimValueCode)
USdiabetes_M <- select(USdiabetes_M, -Dim1ValueCode)
USdiabetes_M <- select(USdiabetes_M, -Value)
USdiabetes_M <- select(USdiabetes_M, -sexCat)
USdiabetes_M <- select(USdiabetes_M, -disease)
```

```{r}
  summary(USdiabetes_F)
  summary(rawUSdiabetes_M)
  #regular summary? or should I just show lm summaries
```

]]y=mx+b, how strong is association between genders (in the US?)
]]average deaths, each gender

### US resp diseases (graphical, numeric)

```{r}
  #resp
plot(rawUSresp_M$Period, rawUSresp_M$FactValueNumeric, type = "l",  col="blue", 
     main = "US resp diseases by sex, over time",
     xlab = "year",
     ylab = "deaths")
lines(rawUSresp_F$Period, rawUSresp_F$FactValueNumeric, type = "l", col = "red")
#legend
legend("topleft",                                       # Add legend to plot
       legend = c("Female", "Male"),
       col = c("red", "blue"),
       lty = 1)
```

Deaths from respiratory diseases rose from 2000 to 2019 for both sexes, but females continue to die more often by a consistent margin (about 4K to 10K). This margin is especially obvious in 2005, when both sexes' deaths spiked in the exact same shape. (Diabetes deaths also spiked in 2005, but not by nearly as much). 

Overall, males seem to be dying from these diseases a bit more often than females, significantly so with diabetes. And respiratory diseases (possibly due to being a broader category) are reconfirmed to kill more people than diabetes does.

## Japan, comparing diseases

```{r}
basicCN <- ggplot(rawJP_allSex,aes(x=disease,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="Resp diseases vs diabetes in Japan")
#^the hell is up w the decimal e values?!?
```

### 2 diseases in JP, between sexes

```{r, include=FALSE}
#graph setup
USdiabetes_allSex <- select(rawUSdiabetes_allSex, -Dim1ValueCode)
USdiabetes_allSex <- select(USdiabetes_allSex, -Value)
USdiabetes_allSex <- select(USdiabetes_allSex, -sexCat)
USdiabetes_allSex <- select(USdiabetes_allSex, -disease)
USdiabetes_allSex <- select(USdiabetes_allSex, -SpatialDimValueCode)

##remove period later so the graph still works
USdiabetes_allSexSummary <- select(USdiabetes_allSex, -Period)
```

```{r}
summary(USdiabetes_allSex)
```

[[summary analysis

```{r}
#diabetes
basicCN <- ggplot(rawJPdiabetes_2sex,aes(x=sexCat,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="Diabetes in Japan by sex")

#resp
basicCN <- ggplot(rawJPresp_2sex,aes(x=sexCat,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="resp in Japan by sex")


#both sexes for 1 disease over time
  #diabetes
plot(rawJPdiabetes_M$Period, rawJPdiabetes_M$FactValueNumeric, type = "l",  col="blue",                               
     main = "Japanese diabetes by sex, over time",
     xlab = "year",
     ylab = "deaths", xlim = c(2000, 2020), ylim = c(5000, 9000))
lines(rawJPdiabetes_F$Period, rawJPdiabetes_F$FactValueNumeric, type = "l", col = "red") 
#legend
legend("topleft",                                      
       legend = c("Female", "Male"),
       col = c("red", "blue"),
       lty = 1)
  #resp
plot(rawJPresp_M$Period, rawJPresp_M$FactValueNumeric, type = "l",  col="blue", 
     main = "Japanese resp diseases by sex, over time",
     xlab = "year",
     ylab = "deaths", xlim = c(2000, 2020), ylim = c(20000, 80000))
lines(rawJPresp_F$Period, rawJPresp_F$FactValueNumeric, type = "l", col = "red")
#legend
legend("topleft",                                       
       legend = c("Female", "Male"),
       col = c("red", "blue"),
       lty = 1)
```
]]analysis. The numbers that are comparatively low to the US can be explained by JP's smaller population; gender ratios were also close enough to 1:1 to not be statistically significant [source], so males dying more often might be explained by females getting better healthcare. 

## Britain, comparing diseases

```{r}
basicCN <- ggplot(rawUK_allSex,aes(x=disease,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="Resp diseases vs diabetes in the UK")
```
]]analysis. Odd that cardiovascular diseases are the most common, after seeing US and JP numbers. Diabetes is the least common killer, which could be explained in two ways: a healthcare system that prevents those with diabetes from dying, or a diet closer to JP than the US. 
### one disease, between sexes

```{r}
#diabetes
basicCN <- ggplot(rawUK_diabetes,aes(x=sexCat,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="Diabetes in the UK by sex")

#resp
basicCN <- ggplot(rawUK_resp,aes(x=sexCat,y=FactValueNumeric))
basicCN + geom_boxplot(notch= FALSE ,outlier.color = "red") + stat_boxplot(geom ='errorbar') + labs(title="resp in the UK by sex")
```

## Both diseases, between the countries

### diabetes
### respiratory diseases






Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
